<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Bares - Grupo de Amigos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            box-sizing: border-box;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 1.1em;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .section h2 {
            color: #374151;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #4b5563;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        button:hover {
            background: #5568d3;
        }

        .button-secondary {
            background: #6b7280;
        }

        .button-secondary:hover {
            background: #4b5563;
        }

        .list {
            list-style: none;
        }

        .list-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .list-item-content {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .delete-btn {
            background: #ef4444;
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .balance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .balance-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .balance-card h3 {
            color: #374151;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .balance-amount {
            font-size: 1.8em;
            font-weight: bold;
            margin: 10px 0;
        }

        .balance-positive {
            color: #10b981;
        }

        .balance-negative {
            color: #ef4444;
        }

        .balance-neutral {
            color: #6b7280;
        }

        .history-list {
            list-style: none;
        }

        .history-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .history-date {
            color: #6b7280;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .history-details {
            color: #374151;
            margin-bottom: 5px;
        }

        .history-amount {
            font-weight: bold;
            font-size: 1.1em;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6b7280;
            margin-top: 5px;
        }

        .back-button {
            background: #3b82f6;
            margin-bottom: 20px;
        }

        .back-button:hover {
            background: #2563eb;
        }

        .avatar-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
            font-size: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            border-color: #3b82f6;
        }

        .avatar-option.selected {
            border-color: #2563eb;
            background: #dbeafe;
        }

        .avatar-display {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: #f3f4f6;
            margin-right: 10px;
        }

        .edit-button {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            margin-left: 10px;
        }

        .edit-button:hover {
            background: #d97706;
        }

        .history-item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .custom-avatar-input {
            display: none;
        }

        .custom-avatar-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px dashed #9ca3af;
            transition: all 0.3s;
            background: #f3f4f6;
            font-size: 24px;
        }

        .custom-avatar-label:hover {
            border-color: #3b82f6;
            background: #dbeafe;
        }

        .avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: #ef4444;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            padding: 0;
        }

        .participant-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f9fafb;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .participant-item:hover {
            background: #f3f4f6;
        }

        .participant-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            cursor: pointer;
        }

        .participant-item label {
            cursor: pointer;
            margin: 0;
            display: flex;
            align-items: center;
            flex: 1;
        }

        .toggle-active-btn {
            background: #10b981;
            padding: 6px 12px;
            font-size: 0.85em;
            margin-right: 5px;
        }

        .toggle-active-btn.inactive {
            background: #6b7280;
        }

        .toggle-active-btn:hover {
            opacity: 0.8;
        }

        .member-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
            margin-left: 10px;
        }

        .member-status.active {
            background: #d1fae5;
            color: #065f46;
        }

        .member-status.inactive {
            background: #f3f4f6;
            color: #6b7280;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .ranking-position {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-right: 20px;
            min-width: 50px;
            text-align: center;
        }

        .ranking-position.gold {
            color: #f59e0b;
        }

        .ranking-position.silver {
            color: #9ca3af;
        }

        .ranking-position.bronze {
            color: #d97706;
        }

        .ranking-info {
            flex: 1;
            display: flex;
            align-items: center;
        }

        .ranking-stats {
            margin-left: auto;
            text-align: right;
        }

        .ranking-amount {
            font-size: 1.5em;
            font-weight: bold;
            color: #10b981;
        }

        .ranking-count {
            color: #6b7280;
            font-size: 0.9em;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: white;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .progress-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            background: #10b981;
            height: 100%;
            transition: width 0.3s;
        }

        .order-member-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .order-member-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .order-member-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #374151;
            margin-left: 10px;
        }

        .order-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }

        .order-item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
        }

        .order-item:hover {
            border-color: #667eea;
            background: #f0f9ff;
        }

        .order-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 500;
            color: #374151;
        }

        .order-item-icon {
            font-size: 20px;
            margin-right: 8px;
        }

        .order-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .order-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .order-btn-minus {
            background: #fee2e2;
            color: #dc2626;
        }

        .order-btn-minus:hover {
            background: #fecaca;
            transform: scale(1.1);
        }

        .order-btn-plus {
            background: #d1fae5;
            color: #059669;
        }

        .order-btn-plus:hover {
            background: #a7f3d0;
            transform: scale(1.1);
        }

        .order-quantity {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            min-width: 30px;
            text-align: center;
        }

        .order-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
        }

        .order-summary-label {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: #374151;
        }

        .order-summary-quantity {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .login-box h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .login-box p {
            color: #6b7280;
            margin-bottom: 30px;
        }

        .login-input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
        }

        .login-input-wrapper {
            position: relative;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1.1em;
            transition: border-color 0.3s;
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-error {
            color: #ef4444;
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
        }

        .login-button {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-button:hover {
            background: #5568d3;
        }

        .app-hidden {
            display: none;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }

        .selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .selector-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .selector-card:hover {
            border-color: #667eea;
            background: #f0f9ff;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .selector-card.selected {
            border-color: #667eea;
            background: #e0e7ff;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .selector-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .selector-name {
            font-weight: bold;
            color: #374151;
            margin-bottom: 5px;
        }

        .selector-count {
            font-size: 0.9em;
            color: #6b7280;
        }

        .detail-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .detail-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .detail-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #374151;
            margin-left: 15px;
        }

        .payment-detail-card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .payment-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .payment-detail-info {
            font-size: 0.9em;
            color: #6b7280;
            margin: 5px 0;
        }

        /* ============================================
           RESPONSIVE - MOBILE STYLES
           ============================================ */
        
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }

            .container {
                padding: 10px;
                max-width: 100%;
            }

            h1 {
                font-size: 1.5em;
                padding: 15px 10px;
            }

            /* Avatar selector en 4 columnas para m√≥vil */
            .avatar-selector {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }

            .avatar-option {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }

            /* Tabs horizontalmente scrollables */
            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 5px;
                padding: 10px 5px;
                margin-bottom: 15px;
            }

            .tab {
                padding: 10px 15px;
                font-size: 0.85em;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Secciones */
            .section {
                padding: 15px;
                margin-bottom: 15px;
            }

            /* Formularios */
            .form-group {
                margin-bottom: 12px;
            }

            .form-group label {
                font-size: 0.9em;
            }

            input, select, button {
                font-size: 14px;
                padding: 10px;
            }

            /* Grids responsive */
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 10px;
            }

            .balance-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .member-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 10px;
            }

            .selector-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 10px;
            }

            .order-items-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 8px;
            }

            /* Stat cards m√°s peque√±as */
            .stat-card {
                padding: 12px;
            }

            .stat-value {
                font-size: 1.3em;
            }

            .stat-label {
                font-size: 0.85em;
            }

            /* Balance cards */
            .balance-card {
                padding: 12px;
            }

            .balance-card h3 {
                font-size: 1em;
            }

            /* Member cards */
            .member-card {
                padding: 12px;
            }

            .member-card h3 {
                font-size: 1em;
            }

            /* Avatares m√°s peque√±os */
            .avatar-display {
                font-size: 20px;
                width: 35px;
                height: 35px;
            }

            /* Lista de items */
            .list-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .list-item-content {
                width: 100%;
            }

            .delete-btn, .edit-btn {
                width: 100%;
                margin-top: 5px;
            }

            /* History list */
            .history-item {
                padding: 12px;
            }

            .history-item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .history-item-amount {
                font-size: 1.2em;
            }

            /* Ranking items */
            .ranking-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
            }

            .ranking-position {
                font-size: 20px;
                width: auto;
                margin-right: 0;
                margin-bottom: 5px;
            }

            .ranking-info {
                margin-bottom: 5px;
            }

            .ranking-stats {
                width: 100%;
            }

            .ranking-amount {
                font-size: 1.3em;
            }

            /* Modal responsive */
            .modal-content {
                width: 95%;
                margin: 20px auto;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-header {
                padding: 15px;
            }

            .modal-header h2 {
                font-size: 1.2em;
            }

            /* Participant selector */
            .participant-selector {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 8px;
            }

            .participant-option {
                padding: 8px;
                font-size: 0.85em;
            }

            /* Login box */
            .login-box {
                padding: 25px;
                width: 95%;
            }

            .login-box h1 {
                font-size: 1.5em;
            }

            .login-box p {
                font-size: 0.9em;
            }

            /* Order items */
            .order-member-card {
                padding: 15px;
            }

            .order-member-name {
                font-size: 1em;
            }

            .order-item {
                padding: 10px;
            }

            .order-item-header {
                font-size: 0.85em;
            }

            .order-btn {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .order-quantity {
                font-size: 18px;
                min-width: 25px;
            }

            /* Order summary */
            .order-summary-item {
                padding: 10px;
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .order-summary-quantity {
                font-size: 1.1em;
            }

            /* Game stat cards */
            .game-stat-card {
                padding: 15px;
            }

            /* Detail sections */
            .detail-section {
                padding: 15px;
            }

            .detail-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .detail-title {
                font-size: 1.2em;
                margin-left: 0;
                margin-top: 10px;
            }

            /* Payment detail cards */
            .payment-detail-card {
                padding: 12px;
            }

            .payment-detail-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .payment-detail-info {
                font-size: 0.85em;
            }

            /* Selector cards */
            .selector-card {
                padding: 15px;
            }

            .selector-icon {
                font-size: 32px;
            }

            .selector-name {
                font-size: 0.9em;
            }

            .selector-count {
                font-size: 0.8em;
            }

            /* Buttons m√°s grandes para touch */
            button {
                min-height: 44px;
                touch-action: manipulation;
            }

            /* Checkbox m√°s grande */
            input[type="checkbox"] {
                width: 20px;
                height: 20px;
            }

            /* Progress bar */
            .progress-bar {
                width: 100%;
            }

            /* Ocultar textos largos en m√≥vil */
            .section h2 {
                font-size: 1.2em;
            }

            .section p {
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.3em;
            }

            .tab {
                padding: 8px 12px;
                font-size: 0.8em;
            }

            /* Avatar selector sigue en 4 columnas pero m√°s peque√±o */
            .avatar-selector {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }

            .avatar-option {
                width: 45px;
                height: 45px;
                font-size: 22px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .stat-card {
                padding: 10px;
            }

            .stat-value {
                font-size: 1.2em;
            }

            .member-grid {
                grid-template-columns: 1fr;
            }

            .selector-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .order-items-grid {
                grid-template-columns: 1fr;
            }

            .participant-selector {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            }

            .modal-content {
                width: 98%;
            }

            .login-box {
                padding: 20px;
            }

            .login-box h1 {
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h1>üçª Gesti√≥n de Bares</h1>
            <p>Introduce la contrase√±a para acceder</p>
            <div class="login-input-group">
                <label for="loginPassword">Contrase√±a:</label>
                <div class="login-input-wrapper">
                    <input 
                        type="text" 
                        id="loginPassword" 
                        class="login-input" 
                        placeholder="Escribe la contrase√±a..."
                        autocomplete="off"
                    >
                </div>
            </div>
            <button class="login-button" onclick="checkPassword()">üîì Entrar</button>
            <div id="loginError" class="login-error">‚ùå Contrase√±a incorrecta</div>
        </div>
    </div>

    <div class="container app-hidden" id="appContainer">
        <h1>üçª Gesti√≥n de Bares</h1>

        <div class="tabs">
            <button class="tab active" onclick="showTab('miembros')">üë• Miembros</button>
            <button class="tab" onclick="showTab('bares')">üè™ Bares</button>
            <button class="tab" onclick="showTab('juegos')">üéÆ Juegos</button>
            <button class="tab" onclick="showTab('articulos')">üç∫ Art√≠culos</button>
            <button class="tab" onclick="showTab('pedidos')">üìã Pedidos</button>
            <button class="tab" onclick="showTab('pagos')">üí∞ Registrar Pago</button>
            <button class="tab" onclick="showTab('balances')">üìä Balances</button>
            <button class="tab" onclick="showTab('balance-juegos')">üéÆ Balance/Juego</button>
            <button class="tab" onclick="showTab('balance-miembros')">üë§ Balance/Miembro</button>
            <button class="tab" onclick="showTab('historial')">üìú Historial</button>
        </div>

        <!-- TAB MIEMBROS -->
        <div id="miembros" class="tab-content active">
            <div class="section">
                <h2>A√±adir Miembro</h2>
                <div class="form-group">
                    <label>Nombre del Miembro:</label>
                    <input type="text" id="memberName" placeholder="Ej: Juan">
                </div>
                <div class="form-group">
                    <label>Selecciona un Avatar:</label>
                    <div class="avatar-selector" id="memberAvatarSelector"></div>
                    <input type="file" id="memberCustomAvatar" class="custom-avatar-input" accept="image/*">
                </div>
                <button onclick="addMember()">‚ûï A√±adir Miembro</button>
            </div>

            <div class="section">
                <h2>Miembros del Grupo</h2>
                <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.95em;">
                    üí° Los miembros marcados como <strong>"Activo"</strong> se incluir√°n autom√°ticamente en cada nueva ronda
                </p>
                <ul id="membersList" class="list"></ul>
            </div>
        </div>

        <!-- TAB BARES -->
        <div id="bares" class="tab-content">
            <div class="section">
                <h2>A√±adir Bar</h2>
                <div class="form-group">
                    <label>Nombre del Bar:</label>
                    <input type="text" id="barName" placeholder="Ej: La Taberna">
                </div>
                <div class="form-group">
                    <label>Selecciona un Avatar:</label>
                    <div class="avatar-selector" id="barAvatarSelector"></div>
                    <input type="file" id="barCustomAvatar" class="custom-avatar-input" accept="image/*">
                </div>
                <button onclick="addBar()">‚ûï A√±adir Bar</button>
            </div>

            <div class="section">
                <h2>Bares Registrados</h2>
                <ul id="barsList" class="list"></ul>
            </div>
        </div>

        <!-- TAB JUEGOS -->
        <div id="juegos" class="tab-content">
            <div class="section">
                <h2>A√±adir Juego</h2>
                <div class="form-group">
                    <label>Nombre del Juego:</label>
                    <input type="text" id="gameName" placeholder="Ej: Domin√≥, Cartas, Dardos...">
                </div>
                <button onclick="addGame()">‚ûï A√±adir Juego</button>
            </div>

            <div class="section">
                <h2>Juegos Registrados</h2>
                <ul id="gamesList" class="list"></ul>
            </div>
        </div>

        <!-- TAB ART√çCULOS -->
        <div id="articulos" class="tab-content">
            <div class="section">
                <h2>A√±adir Art√≠culo</h2>
                <div class="form-group">
                    <label>Nombre del Art√≠culo:</label>
                    <input type="text" id="articleName" placeholder="Ej: Coca-Cola, Cerveza, Caf√©...">
                </div>
                <div class="form-group">
                    <label>Icono:</label>
                    <select id="articleIcon">
                        <option value="üç∫">üç∫ Cerveza</option>
                        <option value="üç∑">üç∑ Vino</option>
                        <option value="ü•§">ü•§ Refresco</option>
                        <option value="‚òï">‚òï Caf√©</option>
                        <option value="ü•É">ü•É Licor</option>
                        <option value="üçπ">üçπ C√≥ctel</option>
                        <option value="üíß">üíß Agua</option>
                        <option value="üßÉ">üßÉ Zumo</option>
                        <option value="üçî">üçî Hamburguesa</option>
                        <option value="üçï">üçï Pizza</option>
                        <option value="ü•™">ü•™ Bocadillo</option>
                        <option value="üçü">üçü Patatas</option>
                        <option value="ü•ó">ü•ó Ensalada</option>
                        <option value="üç∞">üç∞ Postre</option>
                    </select>
                </div>
                <button onclick="addArticle()">‚ûï A√±adir Art√≠culo</button>
            </div>

            <div class="section">
                <h2>Art√≠culos Disponibles</h2>
                <ul id="articlesList" class="list"></ul>
            </div>
        </div>

        <!-- TAB PEDIDOS -->
        <div id="pedidos" class="tab-content">
            <div class="section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h2 style="color: white; margin-bottom: 10px;">üìã Gesti√≥n de Pedidos</h2>
                <p style="margin: 0; opacity: 0.9;">Gestiona el pedido total del grupo. Se mantiene de bar en bar hasta que lo actualices.</p>
            </div>

            <!-- Resumen del pedido actual -->
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">üìù Pedido Actual del Grupo</h2>
                    <button onclick="clearAllOrders()" class="delete-btn">üóëÔ∏è Limpiar Todo</button>
                </div>
                <div id="currentOrderSummary" style="background: #f0f9ff; padding: 20px; border-radius: 10px; border: 2px solid #0369a1;"></div>
            </div>

            <!-- Gesti√≥n de art√≠culos del pedido -->
            <div class="section">
                <h2>üç∫ Gesti√≥n de Art√≠culos</h2>
                <p style="color: #6b7280; margin-bottom: 15px;">
                    üí° Usa los botones + y - para ajustar las cantidades del pedido total
                </p>
                <div id="orderArticlesManager"></div>
            </div>
        </div>

        <!-- TAB PAGOS -->
        <div id="pagos" class="tab-content">
            <div class="section">
                <h2>Registrar Nuevo Pago</h2>
                <div class="form-group">
                    <label>Fecha:</label>
                    <input type="date" id="paymentDate">
                </div>
                <div class="form-group">
                    <label>Bar:</label>
                    <select id="paymentBar">
                        <option value="">Selecciona un bar</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Juego (opcional):</label>
                    <select id="paymentGame">
                        <option value="">Sin juego</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>¬øQui√©n paga esta ronda?</label>
                    <div id="payersList" style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #e5e7eb;">
                        <p style="color: #6b7280; text-align: center;">Primero a√±ade miembros</p>
                    </div>
                </div>
                <div class="form-group">
                    <label>Cantidad total (‚Ç¨):</label>
                    <input type="number" id="paymentAmount" placeholder="0.00" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Participantes en esta ronda:</label>
                    <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <p style="color: #0369a1; margin: 0; font-size: 0.95em;">
                            üí° Por defecto se incluyen los miembros activos. Puedes ajustar si alguien se une o se va.
                        </p>
                    </div>
                    <div id="participantsList" style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #e5e7eb;">
                        <p style="color: #6b7280; text-align: center;">Primero a√±ade miembros</p>
                    </div>
                </div>
                <button onclick="registerPayment()">üí≥ Registrar Pago</button>
            </div>
        </div>

        <!-- TAB BALANCES -->
        <div id="balances" class="tab-content">
            <div class="section">
                <h2>üìä Estad√≠sticas y Balances</h2>
                
                <!-- Filtros -->
                <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #0369a1; margin-bottom: 15px;">üîç Filtros</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group" style="margin: 0;">
                            <label>Bar:</label>
                            <select id="filterBar" onchange="applyFilters()">
                                <option value="">Todos los bares</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Juego:</label>
                            <select id="filterGame" onchange="applyFilters()">
                                <option value="">Todos los juegos</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Desde:</label>
                            <input type="date" id="filterDateFrom" onchange="applyFilters()">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Hasta:</label>
                            <input type="date" id="filterDateTo" onchange="applyFilters()">
                        </div>
                    </div>
                    <button onclick="clearFilters()" class="button-secondary" style="margin-top: 15px;">üîÑ Limpiar Filtros</button>
                </div>

                <!-- Estad√≠sticas Globales -->
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #374151; margin-bottom: 15px;">üìà Estad√≠sticas Generales</h3>
                    <div id="globalStats" class="stats-grid"></div>
                </div>

                <!-- Ranking de Pagadores -->
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #374151; margin-bottom: 15px;">üèÜ Ranking: Qui√©n Ha Pagado M√°s</h3>
                    <div id="payersRanking"></div>
                </div>

                <!-- Estad√≠sticas por Juego -->
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #374151; margin-bottom: 15px;">üéÆ Estad√≠sticas por Juego</h3>
                    <div id="gameStats"></div>
                </div>

                <!-- Estad√≠sticas por Bar -->
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #374151; margin-bottom: 15px;">üè™ Estad√≠sticas por Bar</h3>
                    <div id="barStats"></div>
                </div>

                <!-- Balances por Bar -->
                <h3 style="color: #374151; margin: 20px 0 15px 0;">üí∞ Balances Detallados por Bar</h3>
                <div id="barBalances"></div>
            </div>
        </div>

        <!-- TAB BALANCE POR JUEGO -->
        <div id="balance-juegos" class="tab-content">
            <div class="section">
                <h2>üéÆ Balance Detallado por Juego</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">
                    Selecciona un juego para ver todos los detalles: qui√©n ha pagado, participantes, balances, etc.
                </p>
                <div id="gameBalanceSelector"></div>
            </div>
            
            <div id="gameBalanceDetails"></div>
        </div>

        <!-- TAB BALANCE POR MIEMBRO -->
        <div id="balance-miembros" class="tab-content">
            <div class="section">
                <h2>üë§ Balance Detallado por Miembro</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">
                    Selecciona un miembro para ver todos sus pagos, participaciones y balances detallados.
                </p>
                <div id="memberBalanceSelector"></div>
            </div>
            
            <div id="memberBalanceDetails"></div>
        </div>

        <!-- TAB HISTORIAL -->
        <div id="historial" class="tab-content">
            <div class="section">
                <h2>Historial de Pagos</h2>
                <ul id="historyList" class="history-list"></ul>
            </div>
        </div>
    </div>

    <!-- Modal para editar pago -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Pago</h2>
                <button class="modal-close" onclick="closeEditModal()">‚úï</button>
            </div>
            <div class="form-group">
                <label>Fecha:</label>
                <input type="date" id="editPaymentDate">
            </div>
            <div class="form-group">
                <label>Bar:</label>
                <select id="editPaymentBar"></select>
            </div>
            <div class="form-group">
                <label>Juego (opcional):</label>
                <select id="editPaymentGame">
                    <option value="">Sin juego</option>
                </select>
            </div>
            <div class="form-group">
                <label>¬øQui√©n paga esta ronda?</label>
                <div id="editPayersList" style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #e5e7eb; max-height: 200px; overflow-y: auto;"></div>
            </div>
            <div class="form-group">
                <label>Cantidad total (‚Ç¨):</label>
                <input type="number" id="editPaymentAmount" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label>Participantes en esta ronda:</label>
                <div id="editParticipantsList" style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #e5e7eb; max-height: 200px; overflow-y: auto;"></div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="saveEditedPayment()">üíæ Guardar Cambios</button>
                <button class="button-secondary" onclick="closeEditModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Avatares disponibles
        const memberAvatars = ['üë®', 'üë©', 'üßë', 'üë¶', 'üëß', 'üßî', 'üë®‚Äçü¶∞', 'üë©‚Äçü¶∞', 'üë®‚Äçü¶±', 'üë©‚Äçü¶±', 'üë®‚Äçü¶≥', 'üë©‚Äçü¶≥', 'üë®‚Äçü¶≤', 'üë©‚Äçü¶≤', 'üßë‚Äçü¶∞'];
        const barAvatars = ['üç∫', 'üçª', 'üç∑', 'üç∏', 'üçπ', 'ü•É', 'üçæ', 'üè™', 'üè†', 'üé≠', 'üé™', 'üé®', 'üéµ', '‚öΩ', 'üéÆ'];

        // Sistema de datos
        let data = {
            members: [],
            bars: [],
            payments: [],
            games: [],
            activeMembers: [], // IDs de miembros actualmente activos
            articles: [], // Art√≠culos disponibles (bebidas, comidas, etc)
            currentOrders: {} // Pedido actual global: { articleId: quantity }
        };

        let currentEditingPayment = null;

        // Filtros activos
        let activeFilters = {
            bar: null,
            game: null,
            dateFrom: null,
            dateTo: null
        };

        // Cargar datos del localStorage
        function loadData() {
            const saved = localStorage.getItem('barsManagementData');
            if (saved) {
                data = JSON.parse(saved);
                // Asegurar que activeMembers existe
                if (!data.activeMembers) {
                    data.activeMembers = [];
                }
                // Asegurar que games existe (compatibilidad con versiones anteriores)
                if (!data.games) {
                    data.games = [];
                }
                // Asegurar que articles existe
                if (!data.articles) {
                    data.articles = [];
                }
                // Migrar currentOrders del formato antiguo (por persona) al nuevo (global)
                if (data.currentOrders && typeof data.currentOrders === 'object') {
                    // Verificar si est√° en formato antiguo (tiene IDs de miembros como claves)
                    const firstKey = Object.keys(data.currentOrders)[0];
                    if (firstKey && data.currentOrders[firstKey] && typeof data.currentOrders[firstKey] === 'object') {
                        // Es formato antiguo, convertir a formato nuevo
                        const newOrders = {};
                        Object.keys(data.currentOrders).forEach(memberId => {
                            const memberOrders = data.currentOrders[memberId];
                            Object.keys(memberOrders).forEach(articleId => {
                                if (!newOrders[articleId]) {
                                    newOrders[articleId] = 0;
                                }
                                newOrders[articleId] += memberOrders[articleId];
                            });
                        });
                        data.currentOrders = newOrders;
                        saveData(); // Guardar la migraci√≥n
                    }
                } else {
                    data.currentOrders = {};
                }
            }
        }

        // Guardar datos en localStorage
        function saveData() {
            localStorage.setItem('barsManagementData', JSON.stringify(data));
        }

        // Inicializar selectores de avatares
        function initAvatarSelectors() {
            const memberSelector = document.getElementById('memberAvatarSelector');
            const barSelector = document.getElementById('barAvatarSelector');

            memberSelector.innerHTML = memberAvatars.map((avatar, index) => 
                `<div class="avatar-option ${index === 0 ? 'selected' : ''}" onclick="selectAvatar('member', '${avatar}', ${index})">${avatar}</div>`
            ).join('') + `<label class="custom-avatar-label" for="memberCustomAvatar">üì∑</label>`;

            barSelector.innerHTML = barAvatars.map((avatar, index) => 
                `<div class="avatar-option ${index === 0 ? 'selected' : ''}" onclick="selectAvatar('bar', '${avatar}', ${index})">${avatar}</div>`
            ).join('') + `<label class="custom-avatar-label" for="barCustomAvatar">üì∑</label>`;

            // Manejar upload de im√°genes personalizadas
            document.getElementById('memberCustomAvatar').addEventListener('change', (e) => handleCustomAvatar(e, 'member'));
            document.getElementById('barCustomAvatar').addEventListener('change', (e) => handleCustomAvatar(e, 'bar'));
        }

        let selectedMemberAvatar = memberAvatars[0];
        let selectedBarAvatar = barAvatars[0];

        function selectAvatar(type, avatar, index) {
            const selector = document.getElementById(type === 'member' ? 'memberAvatarSelector' : 'barAvatarSelector');
            const options = selector.querySelectorAll('.avatar-option');
            options.forEach((opt, i) => {
                opt.classList.toggle('selected', i === index);
            });

            if (type === 'member') {
                selectedMemberAvatar = avatar;
            } else {
                selectedBarAvatar = avatar;
            }
        }

        function handleCustomAvatar(event, type) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    const selector = document.getElementById(type === 'member' ? 'memberAvatarSelector' : 'barAvatarSelector');
                    
                    // Deseleccionar otros avatares
                    selector.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
                    
                    // Actualizar el label con la imagen
                    const label = selector.querySelector('.custom-avatar-label');
                    label.innerHTML = `<img src="${imageData}" class="avatar-preview">`;
                    label.style.border = '3px solid #2563eb';
                    
                    if (type === 'member') {
                        selectedMemberAvatar = imageData;
                    } else {
                        selectedBarAvatar = imageData;
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // Funci√≥n para mostrar avatar
        function displayAvatar(avatar) {
            if (avatar.startsWith('data:image')) {
                return `<img src="${avatar}" class="avatar-preview" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">`;
            }
            return `<span class="avatar-display">${avatar}</span>`;
        }

        // Cambiar de tab
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'balances') {
                renderBalances();
            } else if (tabName === 'historial') {
                renderHistory();
            } else if (tabName === 'juegos') {
                renderGames();
            } else if (tabName === 'articulos') {
                renderArticles();
            } else if (tabName === 'pedidos') {
                renderOrderArticlesManager();
                renderCurrentOrderSummary();
            } else if (tabName === 'balance-juegos') {
                renderGameBalanceSelector();
                if (selectedGame !== null) {
                    renderGameBalanceDetails(selectedGame);
                }
            } else if (tabName === 'balance-miembros') {
                renderMemberBalanceSelector();
                if (selectedMember !== null) {
                    renderMemberBalanceDetails(selectedMember);
                }
            }
        }

        // A√±adir miembro
        function addMember() {
            const name = document.getElementById('memberName').value.trim();
            
            if (!name) {
                alert('Por favor, introduce un nombre');
                return;
            }

            if (data.members.some(m => m.name.toLowerCase() === name.toLowerCase())) {
                alert('Este miembro ya existe');
                return;
            }

            const newMember = {
                id: Date.now(),
                name: name,
                avatar: selectedMemberAvatar
            };

            data.members.push(newMember);
            
            // A√±adir como activo por defecto
            data.activeMembers.push(newMember.id);

            saveData();
            document.getElementById('memberName').value = '';
            renderMembers();
            updatePaymentSelects();
            
            // Reset avatar selection
            selectedMemberAvatar = memberAvatars[0];
            initAvatarSelectors();
        }

        // A√±adir bar
        function addBar() {
            const name = document.getElementById('barName').value.trim();
            
            if (!name) {
                alert('Por favor, introduce el nombre del bar');
                return;
            }

            if (data.bars.some(b => b.name.toLowerCase() === name.toLowerCase())) {
                alert('Este bar ya existe');
                return;
            }

            data.bars.push({
                id: Date.now(),
                name: name,
                avatar: selectedBarAvatar
            });

            saveData();
            document.getElementById('barName').value = '';
            renderBars();
            updatePaymentSelects();
            
            // Reset avatar selection
            selectedBarAvatar = barAvatars[0];
            initAvatarSelectors();
        }

        // A√±adir juego
        function addGame() {
            const name = document.getElementById('gameName').value.trim();
            
            if (!name) {
                alert('Por favor, introduce el nombre del juego');
                return;
            }

            if (data.games.some(g => g.name.toLowerCase() === name.toLowerCase())) {
                alert('Este juego ya existe');
                return;
            }

            data.games.push({
                id: Date.now(),
                name: name
            });

            saveData();
            document.getElementById('gameName').value = '';
            renderGames();
            updatePaymentSelects();
        }

        // Eliminar miembro
        function deleteMember(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este miembro? Se perder√°n sus pagos asociados.')) {
                return;
            }

            data.members = data.members.filter(m => m.id !== id);
            data.payments = data.payments.filter(p => p.memberId !== id);
            data.activeMembers = data.activeMembers.filter(mid => mid !== id);
            saveData();
            renderMembers();
            updatePaymentSelects();
        }

        // Alternar estado activo/inactivo de un miembro
        function toggleMemberActive(id) {
            // Asegurar que activeMembers existe
            if (!data.activeMembers) {
                data.activeMembers = [];
            }
            
            const index = data.activeMembers.indexOf(id);
            if (index === -1) {
                data.activeMembers.push(id);
            } else {
                data.activeMembers.splice(index, 1);
            }
            saveData();
            renderMembers();
            renderPayersList();
            renderParticipantsList();
        }

        // Eliminar bar
        function deleteBar(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este bar? Se perder√°n los pagos asociados.')) {
                return;
            }

            data.bars = data.bars.filter(b => b.id !== id);
            data.payments = data.payments.filter(p => p.barId !== id);
            saveData();
            renderBars();
            updatePaymentSelects();
        }

        // Eliminar juego
        function deleteGame(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este juego?')) {
                return;
            }

            data.games = data.games.filter(g => g.id !== id);
            // Actualizar pagos que ten√≠an este juego
            data.payments.forEach(p => {
                if (p.gameId === id) {
                    p.gameId = null;
                }
            });
            saveData();
            renderGames();
            updatePaymentSelects();
        }

        // A√±adir art√≠culo
        function addArticle() {
            const name = document.getElementById('articleName').value.trim();
            const icon = document.getElementById('articleIcon').value;
            
            if (!name) {
                alert('Por favor, introduce el nombre del art√≠culo');
                return;
            }

            if (data.articles.some(a => a.name.toLowerCase() === name.toLowerCase())) {
                alert('Este art√≠culo ya existe');
                return;
            }

            data.articles.push({
                id: Date.now(),
                name: name,
                icon: icon
            });

            saveData();
            document.getElementById('articleName').value = '';
            renderArticles();
            renderOrderArticlesManager();
        }

        // Eliminar art√≠culo
        function deleteArticle(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este art√≠culo?')) {
                return;
            }

            data.articles = data.articles.filter(a => a.id !== id);
            
            // Limpiar pedido de este art√≠culo
            if (data.currentOrders[id]) {
                delete data.currentOrders[id];
            }
            
            saveData();
            renderArticles();
            renderOrderArticlesManager();
            renderCurrentOrderSummary();
        }

        // Renderizar art√≠culos
        function renderArticles() {
            const list = document.getElementById('articlesList');
            if (data.articles.length === 0) {
                list.innerHTML = '<li class="list-item">No hay art√≠culos a√±adidos</li>';
                return;
            }

            list.innerHTML = data.articles.map(article => `
                <li class="list-item">
                    <div class="list-item-content">
                        <span style="margin-right: 10px; font-size: 24px;">${article.icon}</span>
                        <strong>${article.name}</strong>
                    </div>
                    <button class="delete-btn" onclick="deleteArticle(${article.id})">üóëÔ∏è Eliminar</button>
                </li>
            `).join('');
        }

        // Cambiar cantidad de un art√≠culo en el pedido global
        function updateGlobalOrderQuantity(articleId, change) {
            // Inicializar si no existe
            if (!data.currentOrders[articleId]) {
                data.currentOrders[articleId] = 0;
            }
            
            // Aplicar cambio
            data.currentOrders[articleId] += change;
            
            // No permitir cantidades negativas
            if (data.currentOrders[articleId] < 0) {
                data.currentOrders[articleId] = 0;
            }
            
            // Si llega a 0, eliminar el art√≠culo
            if (data.currentOrders[articleId] === 0) {
                delete data.currentOrders[articleId];
            }
            
            saveData();
            renderOrderArticlesManager();
            renderCurrentOrderSummary();
        }

        // Renderizar gestor de art√≠culos del pedido
        function renderOrderArticlesManager() {
            const container = document.getElementById('orderArticlesManager');
            
            if (data.articles.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">Primero a√±ade art√≠culos en la pesta√±a "Art√≠culos"</p>';
                return;
            }

            container.innerHTML = `
                <div class="order-items-grid">
                    ${data.articles.map(article => {
                        const quantity = data.currentOrders[article.id] || 0;
                        return `
                            <div class="order-item">
                                <div class="order-item-header">
                                    <span class="order-item-icon">${article.icon}</span>
                                    <span>${article.name}</span>
                                </div>
                                <div class="order-controls">
                                    <button class="order-btn order-btn-minus" onclick="updateGlobalOrderQuantity(${article.id}, -1)">‚àí</button>
                                    <span class="order-quantity">${quantity}</span>
                                    <button class="order-btn order-btn-plus" onclick="updateGlobalOrderQuantity(${article.id}, 1)">+</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Renderizar resumen del pedido actual
        function renderCurrentOrderSummary() {
            const container = document.getElementById('currentOrderSummary');
            
            // Verificar si hay pedidos
            if (Object.keys(data.currentOrders).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #0369a1;">
                        <p style="font-size: 1.2em; margin: 0;">üìã No hay pedidos activos</p>
                        <p style="margin: 10px 0 0 0; opacity: 0.8;">Usa los botones + y - abajo para a√±adir art√≠culos al pedido</p>
                    </div>
                `;
                return;
            }

            // Renderizar resumen
            let html = '<h3 style="color: #0369a1; margin-bottom: 15px;">üìä Resumen Total del Pedido</h3>';
            
            Object.keys(data.currentOrders).forEach(articleId => {
                const article = data.articles.find(a => a.id === parseInt(articleId));
                if (article && data.currentOrders[articleId] > 0) {
                    html += `
                        <div class="order-summary-item">
                            <div class="order-summary-label">
                                <span style="font-size: 24px; margin-right: 10px;">${article.icon}</span>
                                <span>${article.name}</span>
                            </div>
                            <div class="order-summary-quantity">√ó ${data.currentOrders[articleId]}</div>
                        </div>
                    `;
                }
            });

            // Calcular total de art√≠culos
            const totalItems = Object.values(data.currentOrders).reduce((sum, qty) => sum + qty, 0);
            html += `
                <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #0369a1; display: flex; justify-content: space-between; align-items: center;">
                    <strong style="color: #0369a1; font-size: 1.1em;">TOTAL ART√çCULOS:</strong>
                    <strong style="color: #0369a1; font-size: 1.3em;">${totalItems}</strong>
                </div>
            `;

            container.innerHTML = html;
        }

        // Limpiar todos los pedidos
        function clearAllOrders() {
            if (!confirm('¬øEst√°s seguro de limpiar todo el pedido?')) {
                return;
            }
            
            data.currentOrders = {};
            saveData();
            renderOrderArticlesManager();
            renderCurrentOrderSummary();
            alert('El pedido ha sido limpiado');
        }

        // Variables para los selectores
        let selectedGame = null;
        let selectedMember = null;

        // Renderizar selector de juegos para balance detallado
        function renderGameBalanceSelector() {
            const container = document.getElementById('gameBalanceSelector');
            
            if (data.games.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">No hay juegos registrados</p>';
                return;
            }

            // A√±adir opci√≥n "Sin juego"
            const gamesWithNoGame = [{id: 0, name: 'Sin juego', icon: 'üö´'}, ...data.games.map(g => ({...g, icon: 'üéÆ'}))];

            container.innerHTML = `
                <div class="selector-grid">
                    ${gamesWithNoGame.map(game => {
                        const paymentsCount = data.payments.filter(p => 
                            game.id === 0 ? !p.gameId : p.gameId === game.id
                        ).length;
                        
                        return `
                            <div class="selector-card ${selectedGame === game.id ? 'selected' : ''}" 
                                 onclick="selectGameForBalance(${game.id})">
                                <div class="selector-icon">${game.icon || 'üéÆ'}</div>
                                <div class="selector-name">${game.name}</div>
                                <div class="selector-count">${paymentsCount} ${paymentsCount === 1 ? 'pago' : 'pagos'}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Seleccionar juego y mostrar detalles
        function selectGameForBalance(gameId) {
            selectedGame = gameId;
            renderGameBalanceSelector();
            renderGameBalanceDetails(gameId);
        }

        // Renderizar detalles del balance de un juego
        function renderGameBalanceDetails(gameId) {
            const container = document.getElementById('gameBalanceDetails');
            
            // Filtrar pagos de este juego
            const gamePayments = data.payments.filter(p => 
                gameId === 0 ? !p.gameId : p.gameId === gameId
            );

            if (gamePayments.length === 0) {
                container.innerHTML = `
                    <div class="section">
                        <p style="text-align: center; color: #6b7280;">No hay pagos registrados para este juego</p>
                    </div>
                `;
                return;
            }

            const game = gameId === 0 ? {name: 'Sin juego', icon: 'üö´'} : data.games.find(g => g.id === gameId);
            
            // Calcular estad√≠sticas
            const totalAmount = gamePayments.reduce((sum, p) => sum + p.amount, 0);
            const avgAmount = totalAmount / gamePayments.length;

            // Calcular qui√©n ha pagado cu√°nto
            const payerStats = {};
            gamePayments.forEach(payment => {
                const payers = payment.payers || (payment.memberId ? [payment.memberId] : []);
                const amountPerPayer = payment.amount / (payers.length || 1);
                
                payers.forEach(payerId => {
                    if (!payerStats[payerId]) {
                        const member = data.members.find(m => m.id === payerId);
                        payerStats[payerId] = {
                            member: member,
                            totalPaid: 0,
                            paymentsCount: 0
                        };
                    }
                    payerStats[payerId].totalPaid += amountPerPayer;
                    payerStats[payerId].paymentsCount++;
                });
            });

            const sortedPayers = Object.values(payerStats).sort((a, b) => b.totalPaid - a.totalPaid);

            // Calcular participaciones
            const participantStats = {};
            gamePayments.forEach(payment => {
                const participants = payment.participants || [];
                const amountPerParticipant = payment.amount / (participants.length || 1);
                
                participants.forEach(participantId => {
                    if (!participantStats[participantId]) {
                        const member = data.members.find(m => m.id === participantId);
                        participantStats[participantId] = {
                            member: member,
                            totalOwed: 0,
                            participationsCount: 0
                        };
                    }
                    participantStats[participantId].totalOwed += amountPerParticipant;
                    participantStats[participantId].participationsCount++;
                });
            });

            let html = `
                <div class="section">
                    <div class="detail-header">
                        <span style="font-size: 50px;">${game.icon || 'üéÆ'}</span>
                        <div class="detail-title">${game.name}</div>
                    </div>

                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Total Gastado</div>
                            <div class="stat-value">${totalAmount.toFixed(2)}‚Ç¨</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Pagos</div>
                            <div class="stat-value">${gamePayments.length}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Promedio/Pago</div>
                            <div class="stat-value">${avgAmount.toFixed(2)}‚Ç¨</div>
                        </div>
                    </div>

                    <h3 style="color: #374151; margin: 20px 0 15px 0;">üí∞ Ranking de Pagadores</h3>
                    <div class="balance-grid">
                        ${sortedPayers.map((stat, index) => {
                            const position = index + 1;
                            let medal = '';
                            if (position === 1) medal = 'ü•á';
                            else if (position === 2) medal = 'ü•à';
                            else if (position === 3) medal = 'ü•â';
                            
                            return `
                                <div class="balance-card">
                                    <h3 style="display: flex; align-items: center;">
                                        ${medal ? `<span style="font-size: 24px; margin-right: 10px;">${medal}</span>` : ''}
                                        ${displayAvatar(stat.member.avatar)}
                                        ${stat.member.name}
                                    </h3>
                                    <div style="color: #6b7280; font-size: 0.9em; margin-top: 10px;">
                                        Ha pagado: <strong>${stat.totalPaid.toFixed(2)}‚Ç¨</strong><br>
                                        En ${stat.paymentsCount} ${stat.paymentsCount === 1 ? 'pago' : 'pagos'}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <h3 style="color: #374151; margin: 20px 0 15px 0;">üìú Historial de Pagos</h3>
                    ${gamePayments.sort((a, b) => new Date(b.date) - new Date(a.date)).map(payment => {
                        const bar = data.bars.find(b => b.id === payment.barId);
                        const payers = payment.payers || (payment.memberId ? [payment.memberId] : []);
                        const payerObjects = payers.map(id => data.members.find(m => m.id === id)).filter(m => m);
                        const payerNames = payerObjects.map(m => m.name).join(' + ');
                        const date = new Date(payment.date);
                        
                        const participants = payment.participants || [];
                        const participantNames = participants
                            .map(id => data.members.find(m => m.id === id))
                            .filter(m => m)
                            .map(m => m.name)
                            .join(', ');

                        return `
                            <div class="payment-detail-card">
                                <div class="payment-detail-header">
                                    <strong style="color: #374151;">${payerNames} ‚Üí ${bar ? bar.name : 'Bar desconocido'}</strong>
                                    <strong style="color: #667eea; font-size: 1.1em;">${payment.amount.toFixed(2)}‚Ç¨</strong>
                                </div>
                                <div class="payment-detail-info">
                                    üìÖ ${date.toLocaleDateString('es-ES')} ${date.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}
                                </div>
                                ${participantNames ? `
                                    <div class="payment-detail-info">
                                        üë• Participantes: ${participantNames}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            container.innerHTML = html;
        }

        // Registrar pago
        function registerPayment() {
            const dateInput = document.getElementById('paymentDate').value;
            const barId = parseInt(document.getElementById('paymentBar').value);
            const gameId = document.getElementById('paymentGame').value ? parseInt(document.getElementById('paymentGame').value) : null;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            
            // Obtener pagadores seleccionados
            const payerCheckboxes = document.querySelectorAll('#payersList input[type="checkbox"]:checked');
            const payers = Array.from(payerCheckboxes).map(cb => parseInt(cb.value));
            
            // Obtener participantes seleccionados
            const participantCheckboxes = document.querySelectorAll('#participantsList input[type="checkbox"]:checked');
            const participants = Array.from(participantCheckboxes).map(cb => parseInt(cb.value));

            if (!dateInput) {
                alert('Por favor, selecciona una fecha');
                return;
            }

            if (!barId || !amount || amount <= 0) {
                alert('Por favor, completa todos los campos correctamente');
                return;
            }

            if (payers.length === 0) {
                alert('Debes seleccionar al menos un pagador');
                return;
            }

            if (participants.length === 0) {
                alert('Debes seleccionar al menos un participante');
                return;
            }

            // Crear fecha con hora actual
            const selectedDate = new Date(dateInput + 'T' + new Date().toTimeString().slice(0,8));

            data.payments.push({
                id: Date.now(),
                barId: barId,
                gameId: gameId,
                payers: payers,
                participants: participants,
                amount: amount,
                date: selectedDate.toISOString()
            });

            saveData();
            
            // Limpiar formulario excepto fecha y participantes
            document.getElementById('paymentBar').value = '';
            document.getElementById('paymentGame').value = '';
            document.getElementById('paymentAmount').value = '';
            // Mantener fecha y participantes activos

            alert('Pago registrado correctamente');
        }

        // Editar pago
        function editPayment(paymentId) {
            const payment = data.payments.find(p => p.id === paymentId);
            if (!payment) return;

            currentEditingPayment = paymentId;

            // Llenar el modal con los datos actuales
            const paymentDate = new Date(payment.date);
            document.getElementById('editPaymentDate').value = paymentDate.toISOString().split('T')[0];
            document.getElementById('editPaymentBar').value = payment.barId;
            document.getElementById('editPaymentGame').value = payment.gameId || '';
            document.getElementById('editPaymentAmount').value = payment.amount;

            // Renderizar listas para edici√≥n
            renderEditPayersList(payment.payers || [payment.memberId]); // Compatibilidad con datos antiguos
            renderEditParticipantsList(payment.participants);

            // Mostrar modal
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditingPayment = null;
        }

        function saveEditedPayment() {
            if (!currentEditingPayment) return;

            const dateInput = document.getElementById('editPaymentDate').value;
            const barId = parseInt(document.getElementById('editPaymentBar').value);
            const gameId = document.getElementById('editPaymentGame').value ? parseInt(document.getElementById('editPaymentGame').value) : null;
            const amount = parseFloat(document.getElementById('editPaymentAmount').value);
            
            // Obtener pagadores seleccionados
            const payerCheckboxes = document.querySelectorAll('#editPayersList input[type="checkbox"]:checked');
            const payers = Array.from(payerCheckboxes).map(cb => parseInt(cb.value));
            
            // Obtener participantes seleccionados
            const participantCheckboxes = document.querySelectorAll('#editParticipantsList input[type="checkbox"]:checked');
            const participants = Array.from(participantCheckboxes).map(cb => parseInt(cb.value));

            if (!dateInput) {
                alert('Por favor, selecciona una fecha');
                return;
            }

            if (!barId || !amount || amount <= 0) {
                alert('Por favor, completa todos los campos correctamente');
                return;
            }

            if (payers.length === 0) {
                alert('Debes seleccionar al menos un pagador');
                return;
            }

            if (participants.length === 0) {
                alert('Debes seleccionar al menos un participante');
                return;
            }

            const paymentIndex = data.payments.findIndex(p => p.id === currentEditingPayment);
            if (paymentIndex !== -1) {
                // Mantener hora original pero actualizar fecha
                const originalDate = new Date(data.payments[paymentIndex].date);
                const newDate = new Date(dateInput + 'T' + originalDate.toTimeString().slice(0,8));

                data.payments[paymentIndex] = {
                    ...data.payments[paymentIndex],
                    barId: barId,
                    gameId: gameId,
                    payers: payers,
                    participants: participants,
                    amount: amount,
                    date: newDate.toISOString()
                };

                saveData();
                closeEditModal();
                renderHistory();
                alert('Pago actualizado correctamente');
            }
        }

        // Eliminar pago
        function deletePayment(paymentId) {
            if (!confirm('¬øEst√°s seguro de eliminar este pago?')) {
                return;
            }

            data.payments = data.payments.filter(p => p.id !== paymentId);
            saveData();
            renderHistory();
        }

        // Renderizar miembros
        function renderMembers() {
            const list = document.getElementById('membersList');
            if (data.members.length === 0) {
                list.innerHTML = '<li class="list-item">No hay miembros a√±adidos</li>';
                return;
            }

            // Asegurar que activeMembers existe
            if (!data.activeMembers) {
                data.activeMembers = [];
            }

            list.innerHTML = data.members.map(member => {
                const isActive = data.activeMembers.includes(member.id);
                return `
                    <li class="list-item">
                        <div class="list-item-content">
                            ${displayAvatar(member.avatar)}
                            <strong>${member.name}</strong>
                            <span class="member-status ${isActive ? 'active' : 'inactive'}">
                                ${isActive ? '‚úì Activo' : 'Inactivo'}
                            </span>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="toggle-active-btn ${isActive ? '' : 'inactive'}" onclick="toggleMemberActive(${member.id})">
                                ${isActive ? 'üë§ Activo' : '‚ûï Activar'}
                            </button>
                            <button class="delete-btn" onclick="deleteMember(${member.id})">üóëÔ∏è</button>
                        </div>
                    </li>
                `;
            }).join('');
        }

        // Renderizar bares
        function renderBars() {
            const list = document.getElementById('barsList');
            if (data.bars.length === 0) {
                list.innerHTML = '<li class="list-item">No hay bares a√±adidos</li>';
                return;
            }

            list.innerHTML = data.bars.map(bar => `
                <li class="list-item">
                    <div class="list-item-content">
                        ${displayAvatar(bar.avatar)}
                        <strong>${bar.name}</strong>
                    </div>
                    <button class="delete-btn" onclick="deleteBar(${bar.id})">üóëÔ∏è Eliminar</button>
                </li>
            `).join('');
        }

        // Renderizar juegos
        function renderGames() {
            const list = document.getElementById('gamesList');
            if (data.games.length === 0) {
                list.innerHTML = '<li class="list-item">No hay juegos a√±adidos</li>';
                return;
            }

            list.innerHTML = data.games.map(game => `
                <li class="list-item">
                    <div class="list-item-content">
                        <span style="margin-right: 10px; font-size: 24px;">üéÆ</span>
                        <strong>${game.name}</strong>
                    </div>
                    <button class="delete-btn" onclick="deleteGame(${game.id})">üóëÔ∏è Eliminar</button>
                </li>
            `).join('');
        }

        // Actualizar selects de pagos
        function updatePaymentSelects() {
            const barSelect = document.getElementById('paymentBar');
            const gameSelect = document.getElementById('paymentGame');
            const editBarSelect = document.getElementById('editPaymentBar');
            const editGameSelect = document.getElementById('editPaymentGame');

            // Select de bares
            barSelect.innerHTML = '<option value="">Selecciona un bar</option>' +
                data.bars.map(bar => `<option value="${bar.id}">${bar.name}</option>`).join('');
            
            editBarSelect.innerHTML = data.bars.map(bar => `<option value="${bar.id}">${bar.name}</option>`).join('');

            // Select de juegos
            gameSelect.innerHTML = '<option value="">Sin juego</option>' +
                data.games.map(game => `<option value="${game.id}">${game.name}</option>`).join('');
            
            editGameSelect.innerHTML = '<option value="">Sin juego</option>' +
                data.games.map(game => `<option value="${game.id}">${game.name}</option>`).join('');

            // Establecer fecha de hoy por defecto
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDate').value = today;

            // Actualizar listas
            renderPayersList();
            renderParticipantsList();
        }

        // Renderizar lista de pagadores en formulario de pago
        function renderPayersList() {
            const container = document.getElementById('payersList');
            
            if (data.members.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center;">Primero a√±ade miembros</p>';
                return;
            }

            // Asegurar que activeMembers existe
            if (!data.activeMembers) {
                data.activeMembers = [];
            }

            container.innerHTML = data.members.map(member => {
                const isActive = data.activeMembers.includes(member.id);
                return `
                    <div class="participant-item">
                        <input type="checkbox" id="payer-${member.id}" value="${member.id}" ${isActive ? 'checked' : ''}>
                        <label for="payer-${member.id}">
                            ${displayAvatar(member.avatar)}
                            <span>${member.name}</span>
                        </label>
                    </div>
                `;
            }).join('');
        }

        // Renderizar lista de participantes en formulario de pago
        function renderParticipantsList() {
            const container = document.getElementById('participantsList');
            
            if (data.members.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center;">Primero a√±ade miembros</p>';
                return;
            }

            // Asegurar que activeMembers existe
            if (!data.activeMembers) {
                data.activeMembers = [];
            }

            container.innerHTML = data.members.map(member => {
                const isActive = data.activeMembers.includes(member.id);
                return `
                    <div class="participant-item">
                        <input type="checkbox" id="participant-${member.id}" value="${member.id}" ${isActive ? 'checked' : ''}>
                        <label for="participant-${member.id}">
                            ${displayAvatar(member.avatar)}
                            <span>${member.name}</span>
                        </label>
                    </div>
                `;
            }).join('');
        }

        // Renderizar lista de pagadores en modal de edici√≥n
        function renderEditPayersList(selectedPayers = []) {
            const container = document.getElementById('editPayersList');
            
            if (data.members.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center;">No hay miembros</p>';
                return;
            }

            container.innerHTML = data.members.map(member => {
                const isChecked = selectedPayers.includes(member.id) ? 'checked' : '';
                return `
                    <div class="participant-item">
                        <input type="checkbox" id="edit-payer-${member.id}" value="${member.id}" ${isChecked}>
                        <label for="edit-payer-${member.id}">
                            ${displayAvatar(member.avatar)}
                            <span>${member.name}</span>
                        </label>
                    </div>
                `;
            }).join('');
        }

        // Renderizar lista de participantes en modal de edici√≥n
        function renderEditParticipantsList(selectedParticipants = []) {
            const container = document.getElementById('editParticipantsList');
            
            if (data.members.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center;">No hay miembros</p>';
                return;
            }

            container.innerHTML = data.members.map(member => {
                const isChecked = selectedParticipants.includes(member.id) ? 'checked' : '';
                return `
                    <div class="participant-item">
                        <input type="checkbox" id="edit-participant-${member.id}" value="${member.id}" ${isChecked}>
                        <label for="edit-participant-${member.id}">
                            ${displayAvatar(member.avatar)}
                            <span>${member.name}</span>
                        </label>
                    </div>
                `;
            }).join('');
        }

        // Aplicar filtros
        function applyFilters() {
            activeFilters.bar = document.getElementById('filterBar').value ? parseInt(document.getElementById('filterBar').value) : null;
            activeFilters.game = document.getElementById('filterGame').value ? parseInt(document.getElementById('filterGame').value) : null;
            activeFilters.dateFrom = document.getElementById('filterDateFrom').value || null;
            activeFilters.dateTo = document.getElementById('filterDateTo').value || null;
            
            renderBalances();
        }

        // Limpiar filtros
        function clearFilters() {
            document.getElementById('filterBar').value = '';
            document.getElementById('filterGame').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            
            activeFilters = {
                bar: null,
                game: null,
                dateFrom: null,
                dateTo: null
            };
            
            renderBalances();
        }

        // Obtener pagos filtrados
        function getFilteredPayments() {
            return data.payments.filter(payment => {
                // Filtro por bar
                if (activeFilters.bar && payment.barId !== activeFilters.bar) {
                    return false;
                }
                
                // Filtro por juego
                if (activeFilters.game !== null) {
                    if (activeFilters.game === 0) {
                        // "Sin juego" seleccionado
                        if (payment.gameId) return false;
                    } else {
                        if (payment.gameId !== activeFilters.game) return false;
                    }
                }
                
                // Filtro por fecha desde
                if (activeFilters.dateFrom) {
                    const paymentDate = new Date(payment.date).toISOString().split('T')[0];
                    if (paymentDate < activeFilters.dateFrom) return false;
                }
                
                // Filtro por fecha hasta
                if (activeFilters.dateTo) {
                    const paymentDate = new Date(payment.date).toISOString().split('T')[0];
                    if (paymentDate > activeFilters.dateTo) return false;
                }
                
                return true;
            });
        }

        // Calcular estad√≠sticas globales
        function calculateGlobalStats() {
            const filteredPayments = getFilteredPayments();
            
            const totalAmount = filteredPayments.reduce((sum, p) => sum + p.amount, 0);
            const totalPayments = filteredPayments.length;
            
            // Contar partidas con juego
            const gamesPlayed = filteredPayments.filter(p => p.gameId).length;
            const gamesNotPlayed = totalPayments - gamesPlayed;
            
            // Calcular promedio por pago
            const avgPerPayment = totalPayments > 0 ? totalAmount / totalPayments : 0;
            
            // Contar cu√°ntos pagos diferentes hay por bar
            const barCounts = {};
            filteredPayments.forEach(p => {
                barCounts[p.barId] = (barCounts[p.barId] || 0) + 1;
            });
            const barsWithPayments = Object.keys(barCounts).length;
            
            return {
                totalAmount,
                totalPayments,
                gamesPlayed,
                gamesNotPlayed,
                avgPerPayment,
                barsWithPayments
            };
        }

        // Calcular ranking de pagadores
        function calculatePayersRanking() {
            const filteredPayments = getFilteredPayments();
            const payersStats = {};
            
            filteredPayments.forEach(payment => {
                const payers = payment.payers || (payment.memberId ? [payment.memberId] : []);
                const amountPerPayer = payment.amount / (payers.length || 1);
                
                payers.forEach(payerId => {
                    if (!payersStats[payerId]) {
                        const member = data.members.find(m => m.id === payerId);
                        payersStats[payerId] = {
                            member: member,
                            totalPaid: 0,
                            paymentCount: 0
                        };
                    }
                    payersStats[payerId].totalPaid += amountPerPayer;
                    payersStats[payerId].paymentCount += 1;
                });
            });
            
            return Object.values(payersStats).sort((a, b) => b.totalPaid - a.totalPaid);
        }

        // Calcular estad√≠sticas por juego
        function calculateGameStats() {
            const filteredPayments = getFilteredPayments();
            const gameStats = {};
            
            filteredPayments.forEach(payment => {
                if (!payment.gameId) return; // Ignorar pagos sin juego
                
                if (!gameStats[payment.gameId]) {
                    const game = data.games.find(g => g.id === payment.gameId);
                    if (!game) return;
                    
                    gameStats[payment.gameId] = {
                        gameId: payment.gameId,
                        name: game.name,
                        gamesCount: 0,
                        totalAmount: 0,
                        payerAmounts: {}
                    };
                }
                
                gameStats[payment.gameId].gamesCount++;
                gameStats[payment.gameId].totalAmount += payment.amount;
                
                // Calcular cu√°nto pag√≥ cada persona en este juego
                const payers = payment.payers || (payment.memberId ? [payment.memberId] : []);
                const amountPerPayer = payment.amount / (payers.length || 1);
                
                payers.forEach(payerId => {
                    if (!gameStats[payment.gameId].payerAmounts[payerId]) {
                        gameStats[payment.gameId].payerAmounts[payerId] = 0;
                    }
                    gameStats[payment.gameId].payerAmounts[payerId] += amountPerPayer;
                });
            });
            
            // Procesar estad√≠sticas
            const result = Object.values(gameStats).map(stat => {
                stat.avgPerGame = stat.gamesCount > 0 ? stat.totalAmount / stat.gamesCount : 0;
                
                // Encontrar quien m√°s pag√≥
                const topPayerEntry = Object.entries(stat.payerAmounts)
                    .sort((a, b) => b[1] - a[1])[0];
                
                if (topPayerEntry) {
                    const member = data.members.find(m => m.id === parseInt(topPayerEntry[0]));
                    stat.topPayer = {
                        member: member,
                        amount: topPayerEntry[1]
                    };
                }
                
                return stat;
            });
            
            return result.sort((a, b) => b.totalAmount - a.totalAmount);
        }

        // Calcular estad√≠sticas por bar
        function calculateBarStats() {
            const filteredPayments = getFilteredPayments();
            const barStats = {};
            
            filteredPayments.forEach(payment => {
                if (!barStats[payment.barId]) {
                    const bar = data.bars.find(b => b.id === payment.barId);
                    if (!bar) return;
                    
                    barStats[payment.barId] = {
                        bar: bar,
                        visitsCount: 0,
                        totalAmount: 0,
                        payerAmounts: {},
                        gameCounts: {}
                    };
                }
                
                barStats[payment.barId].visitsCount++;
                barStats[payment.barId].totalAmount += payment.amount;
                
                // Calcular cu√°nto pag√≥ cada persona en este bar
                const payers = payment.payers || (payment.memberId ? [payment.memberId] : []);
                const amountPerPayer = payment.amount / (payers.length || 1);
                
                payers.forEach(payerId => {
                    if (!barStats[payment.barId].payerAmounts[payerId]) {
                        barStats[payment.barId].payerAmounts[payerId] = 0;
                    }
                    barStats[payment.barId].payerAmounts[payerId] += amountPerPayer;
                });
                
                // Contar juegos jugados en este bar
                if (payment.gameId) {
                    if (!barStats[payment.barId].gameCounts[payment.gameId]) {
                        barStats[payment.barId].gameCounts[payment.gameId] = 0;
                    }
                    barStats[payment.barId].gameCounts[payment.gameId]++;
                }
            });
            
            // Procesar estad√≠sticas
            const result = Object.values(barStats).map(stat => {
                stat.avgPerVisit = stat.visitsCount > 0 ? stat.totalAmount / stat.visitsCount : 0;
                
                // Encontrar quien m√°s pag√≥
                const topPayerEntry = Object.entries(stat.payerAmounts)
                    .sort((a, b) => b[1] - a[1])[0];
                
                if (topPayerEntry) {
                    const member = data.members.find(m => m.id === parseInt(topPayerEntry[0]));
                    stat.topPayer = {
                        member: member,
                        amount: topPayerEntry[1]
                    };
                }
                
                // Encontrar juego m√°s jugado
                const topGameEntry = Object.entries(stat.gameCounts)
                    .sort((a, b) => b[1] - a[1])[0];
                
                if (topGameEntry) {
                    const game = data.games.find(g => g.id === parseInt(topGameEntry[0]));
                    stat.topGame = game ? `${game.name} (${topGameEntry[1]})` : null;
                }
                
                return stat;
            });
            
            return result.sort((a, b) => b.totalAmount - a.totalAmount);
        }

        // Calcular balances
        function calculateBalances() {
            const balances = {};
            const filteredPayments = getFilteredPayments();

            // Si hay filtro por bar, solo procesar ese bar
            const barsToProcess = activeFilters.bar 
                ? [data.bars.find(b => b.id === activeFilters.bar)].filter(b => b)
                : data.bars;

            barsToProcess.forEach(bar => {
                balances[bar.id] = {
                    bar: bar,
                    members: {}
                };

                data.members.forEach(member => {
                    balances[bar.id].members[member.id] = {
                        member: member,
                        paid: 0,
                        owes: 0,
                        balance: 0
                    };
                });
            });

            // Calcular lo que cada uno ha pagado y debe (solo pagos filtrados)
            filteredPayments.forEach(payment => {
                if (balances[payment.barId]) {
                    // Obtener lista de pagadores (compatibilidad con datos antiguos)
                    const payers = payment.payers || (payment.memberId ? [payment.memberId] : []);
                    
                    // Sumar lo pagado (dividido entre los pagadores)
                    if (payers.length > 0) {
                        const amountPerPayer = payment.amount / payers.length;
                        payers.forEach(payerId => {
                            if (balances[payment.barId].members[payerId]) {
                                balances[payment.barId].members[payerId].paid += amountPerPayer;
                            }
                        });
                    }

                    // Dividir entre participantes
                    const participants = payment.participants || [];
                    if (participants.length > 0) {
                        const amountPerPerson = payment.amount / participants.length;
                        participants.forEach(participantId => {
                            if (balances[payment.barId].members[participantId]) {
                                balances[payment.barId].members[participantId].owes += amountPerPerson;
                            }
                        });
                    }
                }
            });

            // Calcular balance final
            Object.keys(balances).forEach(barId => {
                const barBalance = balances[barId];
                Object.keys(barBalance.members).forEach(memberId => {
                    const memberBalance = barBalance.members[memberId];
                    memberBalance.balance = memberBalance.paid - memberBalance.owes;
                });
            });

            return balances;
        }

        // Renderizar balances
        function renderBalances() {
            // Actualizar selectores de filtro
            const filterBarSelect = document.getElementById('filterBar');
            const filterGameSelect = document.getElementById('filterGame');
            
            filterBarSelect.innerHTML = '<option value="">Todos los bares</option>' +
                data.bars.map(bar => `<option value="${bar.id}">${bar.name}</option>`).join('');
            
            filterGameSelect.innerHTML = '<option value="">Todos los juegos</option>' +
                '<option value="0">Sin juego</option>' +
                data.games.map(game => `<option value="${game.id}">${game.name}</option>`).join('');
            
            // Restaurar valores de filtros
            if (activeFilters.bar) filterBarSelect.value = activeFilters.bar;
            if (activeFilters.game !== null) filterGameSelect.value = activeFilters.game;
            
            // Renderizar estad√≠sticas globales
            const globalStats = calculateGlobalStats();
            const globalStatsContainer = document.getElementById('globalStats');
            
            globalStatsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">üí∂ Total Gastado</div>
                    <div class="stat-value">${globalStats.totalAmount.toFixed(2)}‚Ç¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìù Total Pagos</div>
                    <div class="stat-value">${globalStats.totalPayments}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üéÆ Con Juego</div>
                    <div class="stat-value">${globalStats.gamesPlayed}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üö´ Sin Juego</div>
                    <div class="stat-value">${globalStats.gamesNotPlayed}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìä Promedio/Pago</div>
                    <div class="stat-value">${globalStats.avgPerPayment.toFixed(2)}‚Ç¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üè™ Bares Visitados</div>
                    <div class="stat-value">${globalStats.barsWithPayments}</div>
                </div>
            `;
            
            // Renderizar ranking de pagadores
            const ranking = calculatePayersRanking();
            const rankingContainer = document.getElementById('payersRanking');
            
            if (ranking.length === 0) {
                rankingContainer.innerHTML = '<p style="text-align: center; color: #6b7280;">No hay datos para mostrar</p>';
            } else {
                const maxAmount = ranking[0].totalPaid;
                rankingContainer.innerHTML = ranking.map((stat, index) => {
                    const position = index + 1;
                    const percentage = (stat.totalPaid / maxAmount) * 100;
                    let positionClass = '';
                    let medal = '';
                    
                    if (position === 1) {
                        positionClass = 'gold';
                        medal = 'ü•á';
                    } else if (position === 2) {
                        positionClass = 'silver';
                        medal = 'ü•à';
                    } else if (position === 3) {
                        positionClass = 'bronze';
                        medal = 'ü•â';
                    }
                    
                    return `
                        <div class="ranking-item">
                            <div class="ranking-position ${positionClass}">
                                ${medal || position}
                            </div>
                            <div class="ranking-info">
                                ${displayAvatar(stat.member.avatar)}
                                <strong style="margin-left: 10px;">${stat.member.name}</strong>
                            </div>
                            <div class="ranking-stats">
                                <div class="ranking-amount">${stat.totalPaid.toFixed(2)}‚Ç¨</div>
                                <div class="ranking-count">${stat.paymentCount} ${stat.paymentCount === 1 ? 'pago' : 'pagos'}</div>
                                <div class="progress-bar" style="width: 200px;">
                                    <div class="progress-fill" style="width: ${percentage}%;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Renderizar estad√≠sticas por juego
            const gameStatsData = calculateGameStats();
            const gameStatsContainer = document.getElementById('gameStats');
            
            if (gameStatsData.length === 0) {
                gameStatsContainer.innerHTML = '<p style="text-align: center; color: #6b7280;">No hay partidas registradas con los filtros aplicados</p>';
            } else {
                gameStatsContainer.innerHTML = gameStatsData.map(stat => `
                    <div class="game-stat-card">
                        <h4 style="color: #374151; margin-bottom: 10px; display: flex; align-items: center;">
                            <span style="font-size: 24px; margin-right: 10px;">üéÆ</span>
                            ${stat.name}
                        </h4>
                        <div class="stat-row">
                            <span class="stat-label">Partidas jugadas:</span>
                            <span class="stat-value">${stat.gamesCount}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total gastado:</span>
                            <span class="stat-value">${stat.totalAmount.toFixed(2)}‚Ç¨</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Promedio por partida:</span>
                            <span class="stat-value">${stat.avgPerGame.toFixed(2)}‚Ç¨</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Quien m√°s pag√≥:</span>
                            <span class="stat-value">
                                ${stat.topPayer ? `${displayAvatar(stat.topPayer.member.avatar)} ${stat.topPayer.member.name} (${stat.topPayer.amount.toFixed(2)}‚Ç¨)` : 'N/A'}
                            </span>
                        </div>
                    </div>
                `).join('');
            }
            
            // Renderizar estad√≠sticas por bar
            const barStatsData = calculateBarStats();
            const barStatsContainer = document.getElementById('barStats');
            
            if (barStatsData.length === 0) {
                barStatsContainer.innerHTML = '<p style="text-align: center; color: #6b7280;">No hay datos de bares con los filtros aplicados</p>';
            } else {
                barStatsContainer.innerHTML = barStatsData.map(stat => `
                    <div class="game-stat-card">
                        <h4 style="color: #374151; margin-bottom: 10px; display: flex; align-items: center;">
                            ${displayAvatar(stat.bar.avatar)}
                            ${stat.bar.name}
                        </h4>
                        <div class="stat-row">
                            <span class="stat-label">Visitas/Pagos:</span>
                            <span class="stat-value">${stat.visitsCount}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total gastado:</span>
                            <span class="stat-value">${stat.totalAmount.toFixed(2)}‚Ç¨</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Promedio por visita:</span>
                            <span class="stat-value">${stat.avgPerVisit.toFixed(2)}‚Ç¨</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Quien m√°s pag√≥:</span>
                            <span class="stat-value">
                                ${stat.topPayer ? `${displayAvatar(stat.topPayer.member.avatar)} ${stat.topPayer.member.name} (${stat.topPayer.amount.toFixed(2)}‚Ç¨)` : 'N/A'}
                            </span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Juego m√°s jugado:</span>
                            <span class="stat-value">${stat.topGame || 'Sin juegos'}</span>
                        </div>
                    </div>
                `).join('');
            }
            
            // Renderizar balances por bar
            const container = document.getElementById('barBalances');
            const balances = calculateBalances();

            if (Object.keys(balances).length === 0) {
                container.innerHTML = '<p>No hay bares registrados o no hay datos con los filtros aplicados</p>';
                return;
            }

            let html = '';

            Object.values(balances).forEach(barBalance => {
                const bar = barBalance.bar;
                html += `
                    <div style="margin-bottom: 30px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="display: flex; align-items: center; margin-bottom: 15px;">
                            ${displayAvatar(bar.avatar)}
                            ${bar.name}
                        </h3>
                        <div class="balance-grid">
                `;

                Object.values(barBalance.members).forEach(memberBalance => {
                    // Solo mostrar miembros con actividad
                    if (memberBalance.paid === 0 && memberBalance.owes === 0) {
                        return;
                    }
                    
                    const balanceClass = memberBalance.balance > 0 ? 'balance-positive' : 
                                       memberBalance.balance < 0 ? 'balance-negative' : 'balance-neutral';
                    const balanceText = memberBalance.balance > 0 ? 'Le deben' : 
                                       memberBalance.balance < 0 ? 'Debe' : 'Saldado';

                    html += `
                        <div class="balance-card">
                            <h3 style="display: flex; align-items: center;">
                                ${displayAvatar(memberBalance.member.avatar)}
                                ${memberBalance.member.name}
                            </h3>
                            <div style="color: #6b7280; font-size: 0.9em; margin-top: 10px;">
                                Ha pagado: <strong>${memberBalance.paid.toFixed(2)}‚Ç¨</strong><br>
                                Debe pagar: <strong>${memberBalance.owes.toFixed(2)}‚Ç¨</strong>
                            </div>
                            <div class="balance-amount ${balanceClass}">
                                ${Math.abs(memberBalance.balance).toFixed(2)}‚Ç¨
                            </div>
                            <div style="color: #6b7280;">${balanceText}</div>
                        </div>
                    `;
                });

                html += `</div></div>`;
            });

            container.innerHTML = html;
        }

        // Renderizar selector de miembros para balance detallado
        function renderMemberBalanceSelector() {
            const container = document.getElementById('memberBalanceSelector');
            
            if (data.members.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">No hay miembros registrados</p>';
                return;
            }

            container.innerHTML = `
                <div class="selector-grid">
                    ${data.members.map(member => {
                        const paymentsAsPayer = data.payments.filter(p => {
                            const payers = p.payers || (p.memberId ? [p.memberId] : []);
                            return payers.includes(member.id);
                        }).length;
                        
                        const paymentsAsParticipant = data.payments.filter(p => 
                            (p.participants || []).includes(member.id)
                        ).length;
                        
                        return `
                            <div class="selector-card ${selectedMember === member.id ? 'selected' : ''}" 
                                 onclick="selectMemberForBalance(${member.id})">
                                <div style="font-size: 40px; margin-bottom: 10px;">${member.avatar}</div>
                                <div class="selector-name">${member.name}</div>
                                <div class="selector-count">
                                    ${paymentsAsPayer} pagado${paymentsAsPayer !== 1 ? 's' : ''} ¬∑ 
                                    ${paymentsAsParticipant} participaci√≥n${paymentsAsParticipant !== 1 ? 'es' : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Seleccionar miembro y mostrar detalles
        function selectMemberForBalance(memberId) {
            selectedMember = memberId;
            renderMemberBalanceSelector();
            renderMemberBalanceDetails(memberId);
        }

        // Renderizar detalles del balance de un miembro
        function renderMemberBalanceDetails(memberId) {
            const container = document.getElementById('memberBalanceDetails');
            const member = data.members.find(m => m.id === memberId);
            
            if (!member) {
                container.innerHTML = '';
                return;
            }

            // Pagos donde este miembro ha pagado
            const paymentsAsPayer = data.payments.filter(p => {
                const payers = p.payers || (p.memberId ? [p.memberId] : []);
                return payers.includes(memberId);
            });

            // Pagos donde este miembro ha participado
            const paymentsAsParticipant = data.payments.filter(p => 
                (p.participants || []).includes(memberId)
            );

            // Calcular totales pagados
            let totalPaid = 0;
            paymentsAsPayer.forEach(payment => {
                const payers = payment.payers || (payment.memberId ? [payment.memberId] : []);
                totalPaid += payment.amount / payers.length;
            });

            // Calcular total que debe
            let totalOwed = 0;
            paymentsAsParticipant.forEach(payment => {
                const participants = payment.participants || [];
                if (participants.length > 0) {
                    totalOwed += payment.amount / participants.length;
                }
            });

            const balance = totalPaid - totalOwed;
            const balanceClass = balance > 0 ? 'balance-positive' : balance < 0 ? 'balance-negative' : 'balance-neutral';
            const balanceText = balance > 0 ? 'Le deben' : balance < 0 ? 'Debe' : 'Saldado';

            // Agrupar por bar
            const paymentsByBar = {};
            paymentsAsPayer.forEach(payment => {
                const bar = data.bars.find(b => b.id === payment.barId);
                if (bar) {
                    if (!paymentsByBar[bar.id]) {
                        paymentsByBar[bar.id] = {
                            bar: bar,
                            payments: [],
                            total: 0
                        };
                    }
                    const payers = payment.payers || (payment.memberId ? [payment.memberId] : []);
                    const amountPaid = payment.amount / payers.length;
                    paymentsByBar[bar.id].payments.push({...payment, amountPaid});
                    paymentsByBar[bar.id].total += amountPaid;
                }
            });

            // Agrupar por juego
            const paymentsByGame = {};
            paymentsAsPayer.forEach(payment => {
                const gameId = payment.gameId || 0;
                const game = gameId === 0 ? {id: 0, name: 'Sin juego', icon: 'üö´'} : data.games.find(g => g.id === gameId);
                
                if (game) {
                    if (!paymentsByGame[gameId]) {
                        paymentsByGame[gameId] = {
                            game: game,
                            count: 0,
                            total: 0
                        };
                    }
                    const payers = payment.payers || (payment.memberId ? [payment.memberId] : []);
                    const amountPaid = payment.amount / payers.length;
                    paymentsByGame[gameId].count++;
                    paymentsByGame[gameId].total += amountPaid;
                }
            });

            let html = `
                <div class="section">
                    <div class="detail-header">
                        <span style="font-size: 50px;">${member.avatar}</span>
                        <div class="detail-title">${member.name}</div>
                    </div>

                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Total Pagado</div>
                            <div class="stat-value" style="color: #10b981;">${totalPaid.toFixed(2)}‚Ç¨</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Debe</div>
                            <div class="stat-value" style="color: #ef4444;">${totalOwed.toFixed(2)}‚Ç¨</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Balance</div>
                            <div class="stat-value ${balanceClass}">${Math.abs(balance).toFixed(2)}‚Ç¨</div>
                            <div style="color: #6b7280; font-size: 0.9em; margin-top: 5px;">${balanceText}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Pagos Realizados</div>
                            <div class="stat-value">${paymentsAsPayer.length}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Participaciones</div>
                            <div class="stat-value">${paymentsAsParticipant.length}</div>
                        </div>
                    </div>

                    <h3 style="color: #374151; margin: 20px 0 15px 0;">üè™ Pagos por Bar</h3>
                    <div class="balance-grid">
                        ${Object.values(paymentsByBar).length > 0 ? Object.values(paymentsByBar).sort((a, b) => b.total - a.total).map(barData => `
                            <div class="balance-card">
                                <h3 style="display: flex; align-items: center;">
                                    <span style="font-size: 24px; margin-right: 10px;">${barData.bar.avatar}</span>
                                    ${barData.bar.name}
                                </h3>
                                <div style="color: #6b7280; font-size: 0.9em; margin-top: 10px;">
                                    Pagado: <strong>${barData.total.toFixed(2)}‚Ç¨</strong><br>
                                    En ${barData.payments.length} ${barData.payments.length === 1 ? 'pago' : 'pagos'}
                                </div>
                            </div>
                        `).join('') : '<p style="text-align: center; color: #6b7280;">No hay pagos en bares</p>'}
                    </div>

                    <h3 style="color: #374151; margin: 20px 0 15px 0;">üéÆ Pagos por Juego</h3>
                    <div class="balance-grid">
                        ${Object.values(paymentsByGame).length > 0 ? Object.values(paymentsByGame).sort((a, b) => b.total - a.total).map(gameData => `
                            <div class="balance-card">
                                <h3 style="display: flex; align-items: center;">
                                    <span style="font-size: 24px; margin-right: 10px;">${gameData.game.icon || 'üéÆ'}</span>
                                    ${gameData.game.name}
                                </h3>
                                <div style="color: #6b7280; font-size: 0.9em; margin-top: 10px;">
                                    Pagado: <strong>${gameData.total.toFixed(2)}‚Ç¨</strong><br>
                                    En ${gameData.count} ${gameData.count === 1 ? 'partida' : 'partidas'}
                                </div>
                            </div>
                        `).join('') : '<p style="text-align: center; color: #6b7280;">No hay pagos con juegos</p>'}
                    </div>

                    <h3 style="color: #374151; margin: 20px 0 15px 0;">üìú Historial de Pagos</h3>
                    ${paymentsAsPayer.length > 0 ? paymentsAsPayer.sort((a, b) => new Date(b.date) - new Date(a.date)).map(payment => {
                        const bar = data.bars.find(b => b.id === payment.barId);
                        const game = payment.gameId ? data.games.find(g => g.id === payment.gameId) : null;
                        const date = new Date(payment.date);
                        const payers = payment.payers || (payment.memberId ? [payment.memberId] : []);
                        const amountPaid = payment.amount / payers.length;
                        
                        const participants = payment.participants || [];
                        const participantNames = participants
                            .map(id => data.members.find(m => m.id === id))
                            .filter(m => m)
                            .map(m => m.name)
                            .join(', ');

                        return `
                            <div class="payment-detail-card">
                                <div class="payment-detail-header">
                                    <strong style="color: #374151;">${bar ? bar.name : 'Bar desconocido'}</strong>
                                    <div>
                                        <span style="color: #6b7280; font-size: 0.9em;">Pag√≥: </span>
                                        <strong style="color: #667eea; font-size: 1.1em;">${amountPaid.toFixed(2)}‚Ç¨</strong>
                                        ${payers.length > 1 ? `<span style="color: #6b7280; font-size: 0.85em;"> (de ${payment.amount.toFixed(2)}‚Ç¨)</span>` : ''}
                                    </div>
                                </div>
                                <div class="payment-detail-info">
                                    üìÖ ${date.toLocaleDateString('es-ES')} ${date.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}
                                </div>
                                ${game ? `
                                    <div class="payment-detail-info">
                                        üéÆ ${game.name}
                                    </div>
                                ` : ''}
                                ${participantNames ? `
                                    <div class="payment-detail-info">
                                        üë• Participantes: ${participantNames}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('') : '<p style="text-align: center; color: #6b7280;">No hay pagos registrados</p>'}
                </div>
            `;

            container.innerHTML = html;
        }

        // Renderizar historial
        function renderHistory() {
            const list = document.getElementById('historyList');
            
            if (data.payments.length === 0) {
                list.innerHTML = '<li class="history-item">No hay pagos registrados</li>';
                return;
            }

            const sortedPayments = [...data.payments].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );

            list.innerHTML = sortedPayments.map(payment => {
                const bar = data.bars.find(b => b.id === payment.barId);
                const game = payment.gameId ? data.games.find(g => g.id === payment.gameId) : null;
                const date = new Date(payment.date);

                if (!bar) return '';

                // Obtener pagadores (compatibilidad con datos antiguos)
                const payers = payment.payers || (payment.memberId ? [payment.memberId] : []);
                const payerObjects = payers
                    .map(id => data.members.find(m => m.id === id))
                    .filter(m => m);
                
                const payerNames = payerObjects.length > 0 
                    ? payerObjects.map(m => m.name).join(' + ')
                    : 'Desconocido';

                const payerAvatars = payerObjects.length > 0
                    ? payerObjects.map(m => displayAvatar(m.avatar)).join('')
                    : '';

                // Obtener nombres de participantes
                const participants = payment.participants || [];
                const participantNames = participants
                    .map(id => data.members.find(m => m.id === id))
                    .filter(m => m)
                    .map(m => m.name)
                    .join(', ');

                return `
                    <li class="history-item">
                        <div class="history-date">
                            üìÖ ${date.toLocaleDateString('es-ES')} - ${date.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}
                        </div>
                        <div class="history-details">
                            ${payerAvatars}
                            <strong>${payerNames}</strong> ${payerObjects.length > 1 ? 'pagaron' : 'pag√≥'} en 
                            ${displayAvatar(bar.avatar)}
                            <strong>${bar.name}</strong>
                            ${game ? `<br><span style="color: #6b7280; font-size: 0.9em;">üéÆ ${game.name}</span>` : ''}
                            ${participantNames ? `<br><span style="color: #6b7280; font-size: 0.9em;">üë• Participantes: ${participantNames}</span>` : ''}
                        </div>
                        <div class="history-amount">
                            ${payment.amount.toFixed(2)}‚Ç¨
                        </div>
                        <div class="history-item-actions">
                            <button class="edit-button" onclick="editPayment(${payment.id})">‚úèÔ∏è Editar</button>
                            <button class="delete-btn" onclick="deletePayment(${payment.id})">üóëÔ∏è Eliminar</button>
                        </div>
                    </li>
                `;
            }).join('');
        }

        // Inicializar aplicaci√≥n
        function init() {
            loadData();
            initAvatarSelectors();
            renderMembers();
            renderBars();
            renderGames();
            renderArticles();
            updatePaymentSelects();
        }

        // Sistema de login
        const CORRECT_PASSWORD = "pocha25";

        function checkPassword() {
            const input = document.getElementById('loginPassword');
            const password = input.value;
            const errorDiv = document.getElementById('loginError');

            if (password === CORRECT_PASSWORD) {
                // Contrase√±a correcta
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appContainer').classList.remove('app-hidden');
                
                // Guardar que ya ha iniciado sesi√≥n
                sessionStorage.setItem('authenticated', 'true');
                
                // Limpiar input
                input.value = '';
                errorDiv.style.display = 'none';
            } else {
                // Contrase√±a incorrecta
                errorDiv.style.display = 'block';
                input.value = '';
                input.focus();
                
                // Animar el error
                errorDiv.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    errorDiv.style.animation = '';
                }, 500);
            }
        }

        // Permitir Enter para enviar
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('loginPassword');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkPassword();
                    }
                });
                
                // Verificar si ya est√° autenticado en esta sesi√≥n
                if (sessionStorage.getItem('authenticated') === 'true') {
                    document.getElementById('loginOverlay').style.display = 'none';
                    document.getElementById('appContainer').classList.remove('app-hidden');
                }
                
                // Focus autom√°tico en el input
                passwordInput.focus();
            }
        });

        // Iniciar cuando cargue la p√°gina
        window.onload = init;
    </script>
</body>
</html>
