<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Pagos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f3ff 0%, #dbeafe 100%);
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .title { font-size: 2rem; font-weight: bold; color: #7c3aed; }
        .btn { 
            padding: 0.75rem 1.5rem; 
            border: none; 
            border-radius: 0.5rem; 
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: #7c3aed; color: white; }
        .btn-primary:hover { background: #6d28d9; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .card { 
            background: white; 
            border-radius: 1rem; 
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        .tabs { 
            display: flex; 
            gap: 0.5rem; 
            margin-bottom: 2rem;
            overflow-x: auto;
            background: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        .tab { 
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            background: #f3f4f6;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 500;
        }
        .tab.active { background: #7c3aed; color: white; }
        .tab:hover:not(.active) { background: #e5e7eb; }
        .input { 
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        .input:focus { 
            outline: none; 
            border-color: #7c3aed;
        }
        .grid { display: grid; gap: 1rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .member-btn, .item-card {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .member-btn.selected { background: #7c3aed; color: white; border-color: #7c3aed; }
        .member-btn.present { background: #3b82f6; color: white; border-color: #3b82f6; }
        .member-btn.loser { background: #ef4444; color: white; border-color: #ef4444; }
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .login-card {
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        .login-icon { font-size: 4rem; margin-bottom: 1rem; }
        .error { color: #ef4444; margin-top: 0.5rem; font-size: 0.875rem; }
        .success { color: #10b981; margin-top: 0.5rem; font-size: 0.875rem; }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
        }
        .stat-value { font-size: 2.5rem; font-weight: bold; }
        .stat-label { font-size: 0.875rem; opacity: 0.9; }
        .history-item {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: #fef3c7;
            color: #92400e;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }
        .hidden { display: none; }
        .label { font-weight: 600; margin-bottom: 0.5rem; display: block; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 1rem; }
        .text-sm { font-size: 0.875rem; }
        .text-gray { color: #6b7280; }
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-2 { gap: 0.5rem; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        const { createClient } = supabase;
        const client = createClient(
            'https://enlfkcvnuwoidhemlxpw.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVubGZrY3ZudXdvaWRoZW1seHB3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1ODQ5MzYsImV4cCI6MjA3NzE2MDkzNn0.cLiCiGjmRvt8bNGzGGlUaxUKF_C9nZKF5kgbX25sjtM'
        );

        let state = {
            auth: false,
            tab: 'registros',
            members: [],
            bars: [],
            payments: [],
            games: [],
            gameResults: [],
            orderItems: [],
            defaultMembers: [],
            currentOrder: {},
            newPayment: { payers: [], present: [], amount: '', bar: '', date: new Date().toISOString().split('T')[0], registered_by: '' }
        };

        async function loadData() {
            const [m, b, p, g, gr, oi, dm] = await Promise.all([
                client.from('members').select('*'),
                client.from('bars').select('*'),
                client.from('payments').select('*'),
                client.from('games').select('*'),
                client.from('game_results').select('*'),
                client.from('order_items').select('*'),
                client.from('default_members').select('*')
            ]);
            if (m.data) state.members = m.data;
            if (b.data) state.bars = b.data;
            if (p.data) state.payments = p.data;
            if (g.data) state.games = g.data;
            if (gr.data) state.gameResults = gr.data;
            if (oi.data) state.orderItems = oi.data;
            if (dm.data) state.defaultMembers = dm.data.map(d => d.member_id);
            state.newPayment.present = [...state.defaultMembers];
        }

        function login(pass) {
            if (pass === 'onfire25') {
                state.auth = true;
                localStorage.setItem('auth', 'true');
                loadData().then(render);
            } else {
                document.getElementById('error').classList.remove('hidden');
            }
        }

        function logout() {
            state.auth = false;
            localStorage.removeItem('auth');
            render();
        }

        function getMemberName(id) {
            const m = state.members.find(x => x.id === id);
            return m ? m.name : 'Desconocido';
        }

        async function addMember() {
            const name = document.getElementById('memberName').value;
            const avatar = document.getElementById('memberAvatar').value;
            if (!name) return;
            const member = { id: Date.now(), name, avatar, photo: '' };
            await client.from('members').insert([member]);
            state.members.push(member);
            document.getElementById('memberName').value = '';
            document.getElementById('memberAvatar').value = '';
            render();
        }

        async function addBar() {
            const name = document.getElementById('barName').value;
            if (!name) return;
            const bar = { id: Date.now(), name };
            await client.from('bars').insert([bar]);
            state.bars.push(bar);
            document.getElementById('barName').value = '';
            render();
        }

        async function addPayment() {
            const { payers, present, amount, bar, date, registered_by } = state.newPayment;
            if (payers.length === 0 || !amount || !bar || !registered_by) {
                alert('Completa todos los campos');
                return;
            }
            const payment = { id: Date.now(), payers, present, amount: parseFloat(amount), bar, date, registered_by };
            await client.from('payments').insert([payment]);
            state.payments.push(payment);
            state.newPayment = { 
                payers: [], 
                present: state.newPayment.present, 
                amount: '', 
                bar: '', 
                date: new Date().toISOString().split('T')[0],
                registered_by: '' 
            };
            render();
        }

        async function deletePayment(id) {
            await client.from('payments').delete().eq('id', id);
            state.payments = state.payments.filter(p => p.id !== id);
            render();
        }

        async function toggleDefaultMember(id) {
            if (state.defaultMembers.includes(id)) {
                await client.from('default_members').delete().eq('member_id', id);
                state.defaultMembers = state.defaultMembers.filter(m => m !== id);
            } else {
                await client.from('default_members').insert([{ member_id: id }]);
                state.defaultMembers.push(id);
            }
            state.newPayment.present = [...state.defaultMembers];
            render();
        }

        function togglePayer(id) {
            if (state.newPayment.payers.includes(id)) {
                state.newPayment.payers = state.newPayment.payers.filter(p => p !== id);
            } else {
                state.newPayment.payers.push(id);
            }
            render();
        }

        function togglePresent(id) {
            if (state.newPayment.present.includes(id)) {
                state.newPayment.present = state.newPayment.present.filter(p => p !== id);
            } else {
                state.newPayment.present.push(id);
            }
            render();
        }

        function calculateStats() {
            return state.members.map(member => {
                const timesPaid = state.payments.filter(p => p.payers.includes(member.id)).length;
                const timesPresent = state.payments.filter(p => p.present.includes(member.id)).length;
                const totalSpent = state.payments
                    .filter(p => p.payers.includes(member.id))
                    .reduce((sum, p) => sum + (p.amount / p.payers.length), 0);
                
                let streak = 0;
                for (let i = state.payments.length - 1; i >= 0; i--) {
                    if (state.payments[i].present.includes(member.id)) {
                        if (!state.payments[i].payers.includes(member.id)) streak++;
                        else break;
                    }
                }

                const rate = timesPresent > 0 ? (timesPaid / timesPresent * 100) : 0;
                const debt = ((timesPresent - timesPaid) / (timesPresent || 1)) * 100;

                return { member, timesPaid, timesPresent, totalSpent, streak, rate, debt };
            }).sort((a, b) => b.timesPaid - a.timesPaid);
        }

        function render() {
            const app = document.getElementById('app');
            
            if (!state.auth) {
                app.innerHTML = `
                    <div class="login-screen">
                        <div class="card login-card">
                            <div class="login-icon">üî•</div>
                            <h1 class="title mb-2">Calculadora de Pagos</h1>
                            <p class="text-gray mb-4">Acceso exclusivo para la pandilla</p>
                            <input type="password" id="passInput" class="input mb-2" placeholder="Contrase√±a" />
                            <p id="error" class="error hidden">‚ùå Contrase√±a incorrecta</p>
                            <button onclick="loginHandler()" class="btn btn-primary" style="width:100%;margin-top:1rem">Entrar</button>
                        </div>
                    </div>
                `;
                document.getElementById('passInput').addEventListener('keypress', e => {
                    if (e.key === 'Enter') login(e.target.value);
                });
                return;
            }

            const tabs = [
                { id: 'registros', label: 'Registros' },
                { id: 'miembros', label: 'Miembros' },
                { id: 'bares', label: 'Bares' },
                { id: 'estadisticas', label: 'Estad√≠sticas' }
            ];

            let content = '';

            if (state.tab === 'registros') {
                content = `
                    <h2 style="font-size:1.5rem;font-weight:bold;margin-bottom:1rem">Nuevo Registro</h2>
                    
                    <div style="background:#dbeafe;padding:1rem;border-radius:0.5rem;margin-bottom:1rem">
                        <p class="text-sm">üí° La ronda se mantiene autom√°ticamente</p>
                    </div>

                    <div class="mb-4">
                        <label class="label">Qui√©n paga:</label>
                        <div class="flex flex-wrap gap-2">
                            ${state.members.map(m => `
                                <button onclick="togglePayerHandler(${m.id})" class="member-btn ${state.newPayment.payers.includes(m.id) ? 'selected' : ''}">
                                    ${m.avatar || 'üë§'} ${m.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="label">Presentes (${state.newPayment.present.length}):</label>
                        <div class="flex flex-wrap gap-2">
                            ${state.members.map(m => `
                                <button onclick="togglePresentHandler(${m.id})" class="member-btn ${state.newPayment.present.includes(m.id) ? 'present' : ''}">
                                    ${m.avatar || 'üë§'} ${m.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="grid grid-2 mb-4">
                        <div>
                            <label class="label">Importe (‚Ç¨):</label>
                            <input type="number" id="payAmount" value="${state.newPayment.amount}" class="input" placeholder="15.50" />
                        </div>
                        <div>
                            <label class="label">Bar:</label>
                            <select id="payBar" class="input">
                                <option value="">Selecciona</option>
                                ${state.bars.map(b => `<option value="${b.name}" ${state.newPayment.bar === b.name ? 'selected' : ''}>${b.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="label">Fecha:</label>
                            <input type="date" id="payDate" value="${state.newPayment.date}" class="input" />
                        </div>
                        <div>
                            <label class="label">üìù Registrado por:</label>
                            <select id="payReg" class="input" style="background:#fef3c7">
                                <option value="">Selecciona</option>
                                ${state.members.map(m => `<option value="${m.id}" ${state.newPayment.registered_by === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <button onclick="addPaymentHandler()" class="btn btn-primary" style="width:100%">‚ûï A√±adir Registro</button>

                    <h3 style="font-size:1.25rem;font-weight:bold;margin:2rem 0 1rem">Historial</h3>
                    ${state.payments.slice().reverse().map(p => `
                        <div class="history-item">
                            <div class="flex justify-between items-center">
                                <div style="flex:1">
                                    <div style="font-weight:600">
                                        ${p.payers.map(id => getMemberName(id)).join(', ')} pag√≥ ${p.amount.toFixed(2)}‚Ç¨
                                    </div>
                                    <div class="text-sm text-gray mt-1">
                                        ${p.bar} ‚Ä¢ ${new Date(p.date).toLocaleDateString('es-ES')}
                                    </div>
                                    ${p.registered_by ? `<span class="badge">üìù ${getMemberName(p.registered_by)}</span>` : ''}
                                </div>
                                <button onclick="deletePaymentHandler(${p.id})" class="btn btn-danger">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('')}
                `;
            } else if (state.tab === 'miembros') {
                content = `
                    <h2 style="font-size:1.5rem;font-weight:bold;margin-bottom:1rem">Miembros</h2>
                    
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="memberName" class="input" placeholder="Nombre" style="flex:1" />
                        <input type="text" id="memberAvatar" class="input" placeholder="üòä" style="width:80px" />
                        <button onclick="addMemberHandler()" class="btn btn-primary">‚ûï</button>
                    </div>

                    <div class="grid grid-2">
                        ${state.members.map(m => `
                            <div class="item-card">
                                <div style="font-size:2rem">${m.avatar || 'üë§'}</div>
                                <div style="flex:1">
                                    <div style="font-weight:600">${m.name}</div>
                                    <button onclick="toggleDefaultHandler(${m.id})" class="text-sm ${state.defaultMembers.includes(m.id) ? 'success' : 'text-gray'}">
                                        ${state.defaultMembers.includes(m.id) ? '‚úì' : '‚úó'} Por defecto
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (state.tab === 'bares') {
                content = `
                    <h2 style="font-size:1.5rem;font-weight:bold;margin-bottom:1rem">Bares</h2>
                    
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="barName" class="input" placeholder="Nombre del bar" style="flex:1" />
                        <button onclick="addBarHandler()" class="btn btn-primary">‚ûï</button>
                    </div>

                    <div class="grid grid-2">
                        ${state.bars.map(b => `
                            <div class="item-card">
                                <span style="font-size:1.5rem">üç∫</span>
                                <span style="font-weight:600;flex:1">${b.name}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (state.tab === 'estadisticas') {
                const stats = calculateStats();
                content = `
                    <h2 style="font-size:1.5rem;font-weight:bold;margin-bottom:1rem">Estad√≠sticas</h2>
                    
                    <div class="grid grid-2 mb-4">
                        <div class="stat-card">
                            <div class="stat-label">Total Salidas</div>
                            <div class="stat-value">${state.payments.length}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Miembros</div>
                            <div class="stat-value">${state.members.length}</div>
                        </div>
                    </div>

                    <h3 style="font-size:1.25rem;font-weight:bold;margin-bottom:1rem">Individuales</h3>
                    ${stats.map(s => `
                        <div class="history-item mb-2">
                            <div class="flex items-center gap-2 mb-2">
                                <div style="font-size:2rem">${s.member.avatar || 'üë§'}</div>
                                <div style="font-size:1.25rem;font-weight:bold">${s.member.name}</div>
                            </div>
                            <div class="grid grid-2 text-sm">
                                <div><span class="text-gray">Pag√≥:</span> <strong style="color:#10b981">${s.timesPaid}</strong></div>
                                <div><span class="text-gray">Presente:</span> <strong>${s.timesPresent}</strong></div>
                                <div><span class="text-gray">Sin pagar:</span> <strong style="color:#ef4444">${s.timesPresent - s.timesPaid}</strong></div>
                                <div><span class="text-gray">Racha:</span> <strong>${s.streak} üî•</strong></div>
                                <div><span class="text-gray">Gastado:</span> <strong>${s.totalSpent.toFixed(2)}‚Ç¨</strong></div>
                                <div><span class="text-gray">Tasa:</span> <strong>${s.rate.toFixed(0)}%</strong></div>
                            </div>
                        </div>
                    `).join('')}
                `;
            }

            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1 class="title">üç∫ Calculadora</h1>
                        <button onclick="logoutHandler()" class="btn btn-danger">Cerrar Sesi√≥n</button>
                    </div>
                    
                    <div class="tabs">
                        ${tabs.map(t => `
                            <button onclick="changeTab('${t.id}')" class="tab ${state.tab === t.id ? 'active' : ''}">
                                ${t.label}
                            </button>
                        `).join('')}
                    </div>

                    <div class="card">
                        ${content}
                    </div>
                </div>
            `;

            // Event listeners
            if (state.tab === 'registros') {
                const amt = document.getElementById('payAmount');
                const bar = document.getElementById('payBar');
                const date = document.getElementById('payDate');
                const reg = document.getElementById('payReg');
                if (amt) amt.addEventListener('change', e => state.newPayment.amount = e.target.value);
                if (bar) bar.addEventListener('change', e => state.newPayment.bar = e.target.value);
                if (date) date.addEventListener('change', e => state.newPayment.date = e.target.value);
                if (reg) reg.addEventListener('change', e => state.newPayment.registered_by = parseInt(e.target.value));
            }
        }

        // Global handlers
        window.loginHandler = () => login(document.getElementById('passInput').value);
        window.logoutHandler = logout;
        window.changeTab = (tab) => { state.tab = tab; render(); };
        window.addMemberHandler = addMember;
        window.addBarHandler = addBar;
        window.addPaymentHandler = addPayment;
        window.deletePaymentHandler = deletePayment;
        window.toggleDefaultHandler = toggleDefaultMember;
        window.togglePayerHandler = togglePayer;
        window.togglePresentHandler = togglePresent;

        // Init
        if (localStorage.getItem('auth') === 'true') {
            state.auth = true;
            loadData().then(render);
        } else {
            render();
        }
    </script>
</body>
</html>
